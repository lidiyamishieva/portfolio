---
title: "Reproducible manuscript"
author: "Lidiya Mishieva"
format: pdf
editor: visual
bibliography: references.bib
---

## Introduction

This document contains results of a simulation study by @boulesteix_introduction_2020, produced using a reproducible simulation script. Part of the manuscript is also added to the output. The simulation study aims to investigate the impact of measurement error on (continuous) exposure and/or (continuous) confounding variable.

## Manuscript

```{r}
#| label: random-number-generator
#| include: false

# set the random number generator version
RNGkind(kind = "Mersenne-Twister",
        normal.kind = "Inversion",
        sample.kind = "Rejection") 
```

```{r}
#| label: session-info
#| include: false
#| 
sessionInfo()
# writeLines(capture.output(sessionInfo()), "session-info.txt")
```

```{r}
#| label: load-libraries
#| include: false

# load packages, install first if necessary

# install.packages("Hmisc")
# install.packages("mice")
# install.packages("tidyverse")

library(Hmisc)
library(mice)
library(tidyverse)
```

```{r}
#| label: read-data
#| include: false

# set working directory
# setwd("")

# The data can be dowloaded in xpt form from https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015

# read data
d1 <- sasxport.get("data/raw-data/DEMO_I.XPT")
d2 <- sasxport.get("data/raw-data/BPX_I.XPT")
d3 <- sasxport.get("data/raw-data/BMX_I.XPT")
d4 <- sasxport.get("data/raw-data/GHB_I.XPT")
d5 <- sasxport.get("data/raw-data/TCHOL_I.XPT")
```

```{r}
#| label: filter-and-merge-data
#| include: false

# filter
d1.t <- subset(d1,select=c("seqn","riagendr","ridageyr"))
d2.t <- subset(d2,select=c("seqn","bpxsy1"))
d3.t <- subset(d3,select=c("seqn","bmxbmi"))
d4.t <- subset(d4,select=c("seqn","lbxgh"))
d5.t <- subset(d5,select=c("seqn","lbdtcsi"))

# merge
d <- merge(d1.t,d2.t)
d <- merge(d,d3.t)
d <- merge(d,d4.t)
d <- merge(d,d5.t)

```

```{r}
#| label: rename-variables
#| include: false

# RIAGENDR - Gender
# RIDAGEYR - Age in years at screening
# BPXSY1 - Systolic: Blood pres (1st rdg) mm Hg
# BMXBMI - Body Mass Index (kg/m**2)
# LBDTCSI - Total Cholesterol (mmol/L)
# LBXGH - Glycohemoglobin (%)

# rename variables:
d$age <- d$ridageyr
d$sex <- d$riagendr
d$bp <- d$bpxsy1
d$bmi <- d$bmxbmi
d$HbA1C <- d$lbxgh
d$chol <- d$lbdtcsi

# only consider cases that are >= 18 years old
d$age[d$age<18] <- NA
```

```{r}
#| label: empirical-analysis
#| include: false

# select complete cases:
dc <- cc(subset(d,select=c("age","sex","bmi","HbA1C","bp")))

# analysis:
summary(lm(bp ~ HbA1C + age + as.factor(sex), data=dc))
confint(lm(bp ~ HbA1C + age + as.factor(sex), data=dc))
summary(lm(bp ~ HbA1C + bmi + age + as.factor(sex), data=dc))
confint(lm(bp ~ HbA1C + bmi + age + as.factor(sex), data=dc))

# save models:
unadjusted_model <- lm(bp ~ HbA1C + age + as.factor(sex), data=dc)
adjusted_model <- lm(bp ~ HbA1C + bmi + age + as.factor(sex), data=dc)
```

```{r}
#| label: simulation-error
#| include: false

# simulation of measurement error:
ref <- lm(bp ~ HbA1C + bmi + age + as.factor(sex), data=dc)$coef[2]
n.sim <- 1e3
perc.me.exp <- seq(0,.5,.1)
perc.me.conf<- seq(0,.5,.1)
scenarios <- expand.grid(perc.me.exp,perc.me.conf)
var.exp <- var(dc$HbA1C)
var.conf <- var(dc$bmi)
n <- dim(dc)[1]
beta.hat <- matrix(ncol=dim(scenarios)[1], nrow=n.sim)

for (k in 1:n.sim){
  print(k)
  set.seed(k)
  for (i in 1:dim(scenarios)[1]){
    var.me.exp <- var.exp*scenarios[i,1]/(1-scenarios[i,1])
    var.me.conf <- var.conf*scenarios[i,2]/(1-scenarios[i,2])
    dc$HbA1C.me <- dc$HbA1C + rnorm(dim(dc)[1], 0, sqrt(var.me.exp) )
    dc$bmi.me <- dc$bmi + rnorm(dim(dc)[1], 0, sqrt(var.me.conf) )
    beta.hat[k,i] <- lm(bp ~ HbA1C.me + age + bmi.me + as.factor(sex), data=dc)$coef[2]
  }}

```

### An example of a statistical simulation

For illustration, in this section we consider a simple simulation study that investigates the impact of measurement error in linear regression analysis, inspired by a previous study [@brakenhoff_random_2018] . See the overview of its key features in the right column of Table 2. Our study is completely reproducible using the R code provided in [online supplemental file 1](https://bmjopen.bmj.com/content/10/12/e039921#DC1), which uses freely available data. In epidemiological studies of the relation between an exposure and an outcome, this relation is often estimated using regression analysis. As an example, we consider a study of the association between glycated haemoglobin (HbA1c) levels and systolic blood pressure assessed using linear regression. Data from 5092 subjects in the 2015–2016 National Health and Nutrition Examination Survey (NHANES) [@zipf2013health] are used to obtain an estimate of the effect of HbA1c on systolic blood pressure, while adjusting for age, gender and body mass index (BMI). Details on the data are described on the NHANES website (<https://wwwn.cdc.gov/nchs/nhanes/>). After adjustment for age and gender, it was estimated that HbA1c increases systolic blood pressure by `r round(unadjusted_model$coefficients[["HbA1C"]], 2)`  mmHg (95% CI `r round(confint(unadjusted_model)[2, 1], 2)` to `r round(confint(unadjusted_model)[2, 2], 2)`) per unit increase in HbA1c. Additional adjustment for BMI resulted in a considerable change in the effect estimate: HbA1c was estimated to increase blood pressure by `r round(adjusted_model$coefficients[["HbA1C"]], 2)`  mmHg (95% CI `r round(confint(adjusted_model)[2, 1], 2)` to `r round(confint(adjusted_model)[2, 2], 2)`) per unit increase in HbA1c.

The confounding variable BMI as well as the exposure variable HbA1c may be subject to measurement error. For example, BMI may be self-reported (instead of a standardised measurement using scales) or technical problems in the lab may have affected the HbA1c measurement. Therefore, researchers may want to know the possible impact of measurement error of the exposure and/or confounding variable(s) in terms of bias [@brakenhoff_measurement_2018]. We are interested both in the direction and magnitude of this bias.

One way to investigate the possible impact of measurement error is through a small simulation study [@brakenhoff_random_2018], whose steps are schematically represented in Figure 1. For the purpose of this example, the original recordings in the NHANES data were assumed to be measured without error (step 1 in Figure 1). Then, in addition, new artificial variables were created that represented HbA1c and BMI, but for the situation in which these are measured with error. To create these variables, measurement error was artificially added to the exposure variable (HbA1c) and/or the confounding variable (BMI) (step 2 in Figure 1). These errors were drawn from a normal distribution with a mean zero and were independent of all variables considered. This type of measurement error is often referred to as classical measurement error [@carroll_measurement_2006]. The variance of the normal distribution, defining the amount of measurement error added, was altered for different scenarios. Scenarios ranged from no measurement error on either HbA1c or BMI (reference scenario) to 50% of the variance in HbA1c and/or BMI attributable to measurement error. To minimise the impact of simulation error, each scenario was repeated 1000 times and the results were averaged per scenario over these 1000 repetitions.

[![Schematic illustration of the key steps of the example simulation study.](figures/bmjopen-2020-December-10-12--F1.large.jpg){width="440"}](https://bmjopen.bmj.com/content/bmjopen/10/12/e039921/F1.large.jpg?width=800&height=600&carousel=1)

Figure 2 shows the impact of measurement error on HbA1c and/or BMI on the estimate of the regression coefficient of HbA1c (steps 3 and 4 in Figure 1). The relation between HbA1c and systolic blood pressure was attenuated when measurement error was added to HbA1c, but not when measurement error was added to BMI. The association became stronger as measurement error was added solely to the confounding variable BMI. The reason for this effect is that, with increasing levels of measurement error on BMI, adjustment for the confounding due to BMI becomes less efficient and the effect estimate gets closer to the unadjusted estimate (`r round(unadjusted_model$coefficients[["HbA1C"]], 2)` mmHg). Due to measurement error, a type of residual confounding is introduced. In the case of measurement error on HbA1c as well as BMI, both phenomena play a role and may cancel each other out. In this study, measurement error on HbA1c seemed more influential than measurement error on BMI.

```{r}
#| label: create-figure
#| echo: false
#| fig-cap: "Estimates of the association between HbA1c levels and systolic blood pressure after adjustment for confounding by BMI under various simulation scenarios characterised by different levels of measurement error. Numbers represent effect estimates averaged over 1000 simulation repetitions. Red shading represents low (averaged) estimates. Blue shading represents high (averaged) estimates. CIs are omitted for clarity. See text for details. BMI, body mass index; HbA1c, glycated haemoglobin."

# create figure
tot.mat <- cbind(100*scenarios,apply(beta.hat,2,mean))
colnames(tot.mat) <- c("me.exp","me.conf","estimate")
FIGURE <- ggplot(tot.mat, aes(me.exp, me.conf)) +
  geom_tile(color="white",aes(fill = estimate)) +
  geom_text(aes(label = round(estimate, 2))) +
  scale_fill_gradient2(low="#D55E00",mid="white",high = "#56B4E9", midpoint=ref) +
  labs(x=paste("% of total variance of HbA1c due to measurement error"),
       y=paste("% of total variance of BMI due to measurement error")) +
  coord_equal()+
  scale_y_continuous(breaks=unique(tot.mat[,1]))+
  scale_x_continuous(breaks=unique(tot.mat[,1]))+
  theme(panel.background = element_rect(fill='white', colour='grey'),
        plot.title=element_text(hjust=0),
        axis.ticks=element_blank(),
        axis.title=element_text(size=10),
        axis.text=element_text(size=8),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

# print figure
FIGURE
```

```{r}
#| include: false
#| label: save-figure

# save figure
# savePlot("Figure_STRATOS.tif", type="tif")

# ensuring that export works from the .qmd file
ggsave("figures/Figure_STRATOS.tif", plot = FIGURE)
```

This example illustrates how a simple simulation study could provide insight into an important potential source of bias, namely measurement error. Here, we only considered classical measurement error, but simulations could easily be extended to incorporate more complex forms of measurement error. For example, the errors may not be drawn from a normal distribution with mean zero or may not be independent of all other variables considered. Instead, the mean of the distribution of errors may depend on the value of another variable in the model, for example, error on BMI may depend on gender. Furthermore, non-normal distributions may be considered, or scenarios in which the variance of the errors depends on the true value of the measurement (heteroskedastic errors), among other possible extensions.

Finally, we note that researchers conducting small-scale simulation studies like the one presented here should reflect on the plausibility of the scenarios considered. For example, knowing whether it is realistic to assume that 50% of the total variance of HbA1c and BMI is due to measurement error (top-right scenario in Figure 2) requires subject-matter knowledge.

## References
